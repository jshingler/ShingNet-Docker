services:
  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    restart: always
    ports:
      - "3300:3000"
    volumes:
      - grafana_data:/var/lib/grafana
    environment:
      # --- Basic setup ---
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_SECURITY_ALLOW_EMBEDDING=true  # 

      # --- Correct domain + subpath ---
      #- GF_SERVER_DOMAIN=jshingler.asuscomm.com
      #- GF_SERVER_ROOT_URL=https://jshingler.asuscomm.com/grafana/
      - GF_SERVER_DOMAIN=grafana.jshingler.net
      - GF_SERVER_ROOT_URL=https://grafana.jshingler.net/
      - GF_SERVER_SERVE_FROM_SUB_PATH=true

      # --- Key fix: trust proxy auth headers ---
      #- GF_AUTH_PROXY_ENABLED=true
      #- GF_AUTH_PROXY_HEADER_NAME=X-Forwarded-User
      #- GF_AUTH_PROXY_AUTO_SIGN_UP=true
      #- GF_AUTH_PROXY_HEADER_PROPERTY=username
      #- GF_AUTH_ANONYMOUS_ENABLED=false
      #- GF_AUTH_DISABLE_LOGIN_FORM=true
      #- GF_AUTH_DISABLE_SIGNOUT_MENU=false

      # --- Key fixes for reverse proxy authentication ---
      - GF_AUTH_PROXY_ENABLED=true
        #- GF_AUTH_PROXY_HEADER_NAME=X-Forwarded-User
      - GF_AUTH_PROXY_HEADER_NAME=X-Auth-Request-User
      - GF_AUTH_PROXY_HEADER_PROPERTY=username
      - GF_AUTH_PROXY_AUTO_SIGN_UP=true
      - GF_AUTH_ANONYMOUS_ENABLED=false
      - GF_AUTH_DISABLE_LOGIN_FORM=true
      - GF_AUTH_DISABLE_SIGNOUT_MENU=true  # prevents redirect loop on logout
      - GF_SECURITY_ALLOW_EMBEDDING=true   # optional for iframes

        #- GF_AUTH_PROXY_HEADER_NAME=X-Auth-Request-Email
        #- GF_AUTH_PROXY_HEADER_PROPERTY=email
      - GF_USERS_AUTO_ASSIGN_ORG=true
      - GF_USERS_AUTO_ASSIGN_ORG_ROLE=Admin

      # --- Reverse proxy protocol awareness ---
      # SSL is terminated in NGINX
      #- GF_SERVER_PROTOCOL=https
      - GF_SERVER_PROTOCOL=http
      - GF_SERVER_HTTP_PORT=3000
      - GF_SERVER_ENFORCE_DOMAIN=false     # prevents redirect loops
        #- GF_SERVER_ENFORCE_SUB_PATH=true
      - GF_SERVER_ENFORCE_SUB_PATH=false # NEW




    networks:
      - observability

networks:
  observability:
    external: true

